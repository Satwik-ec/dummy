#!/bin/bash

echo "========== P4 Safe Sync Script =========="

# ------------------------------------
# 1. Check for opened / unshelved files
# ------------------------------------
OPENED=$(p4 opened 2>/dev/null)

if [ -n "$OPENED" ]; then
    echo "‚ö†Ô∏è Opened / unshelved files detected:"
    echo "$OPENED"

    read -p "Do you want to revert ALL opened files? (y/n): " rev_ans
    if [[ "$rev_ans" == "y" ]]; then
        echo "üîÑ Reverting all opened files..."
        p4 revert //...
        echo "‚úÖ All opened files reverted."
    else
        echo "‚ùå Revert skipped. Exiting to avoid unsafe sync."
        return 1
    fi
else
    echo "‚úÖ No opened or unshelved files."
fi

# ------------------------------------
# 2. Check if latest sync is available
# ------------------------------------
echo "üîç Checking for latest updates..."
p4 sync -n > /tmp/p4_sync_preview.txt

if [ -s /tmp/p4_sync_preview.txt ]; then
    echo "‚ö†Ô∏è New updates are available."
    read -p "Do you want to sync with latest? (y/n): " sync_ans
else
    echo "‚úÖ Workspace already up to date."
    sync_ans="n"
fi

# ------------------------------------
# 3. Sync ONLY if user agrees
# ------------------------------------
if [[ "$sync_ans" == "y" ]]; then
    echo "üîÑ Syncing to latest..."
    p4 sync
    echo "‚úÖ Sync completed."
else
    echo "‚è≠Ô∏è Sync skipped by user."
    return 0
fi

echo "========================================"
