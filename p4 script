#!/bin/tcsh

echo "========== P4 Safe Sync Script =========="

# ------------------------------------
# 1. Check for opened / unshelved files
# ------------------------------------
set OPENED = "`p4 opened 2>/dev/null`"

if ("$OPENED" != "") then
    echo "‚ö†Ô∏è Opened / unshelved files detected:"
    echo "$OPENED"

    echo -n "Do you want to revert ALL opened files? (y/n): "
    set rev_ans = $<

    if ("$rev_ans" == "y") then
        echo "üîÑ Reverting all opened files..."
        p4 revert //...
        echo "‚úÖ All opened files reverted."
    else
        echo "‚ùå Revert skipped. Exiting to avoid unsafe sync."
        return
    endif
else
    echo "‚úÖ No opened or unshelved files."
endif

# ------------------------------------
# 2. Check if latest sync is available
# ------------------------------------
echo "üîç Checking for latest updates..."
set SYNC_PREVIEW = "`p4 sync -n 2>/dev/null`"

if ("$SYNC_PREVIEW" != "") then
    echo "‚ö†Ô∏è New updates are available."
    echo -n "Do you want to sync with latest? (y/n): "
    set sync_ans = $<
else
    echo "‚úÖ Workspace already up to date."
    set sync_ans = "n"
endif

# ------------------------------------
# 3. Sync ONLY if user agrees
# ------------------------------------
if ("$sync_ans" == "y") then
    echo "üîÑ Syncing to latest..."
    p4 sync
    echo "‚úÖ Sync completed."
else
    echo "‚è≠Ô∏è Sync skipped by user."
    return
endif

echo "========================================"
